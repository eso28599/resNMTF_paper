---
title: "Reproducing Results"
output:
  html_document:
    theme: united
---

This document provides a step-by-step guide to reproduce the results of the paper ["Multi-view biclustering via non-negative matrix tri-factorisation"]{https://arxiv.org/abs/2502.13698}. The code requires our `R` packages `resnmtf` and `bisilhouette`, the github pages for which can be found [here]{https://eso28599.github.io/resnmtf/} and [here]{https://eso28599.github.io/bisilhouette/}respectively.

```{r}
# Install and load required packages
if (!require(devtools)) {
  install.packages("devtools")
  library(devtools)
}
devtools::install_github("eso28599/resnmtf")
devtools::install_github("eso28599/bisilhouette")
source("install_packages.r")
library(resnmtf)
library(bisilhouette)
library(knitr)
```

In order to run this document, you need fork the github repository to your local machine. The repository can be found [here]{https://github.com/eso28599/resNMTF_paper}. 

Further, as one of the methods ResNMTF is compared against a method written in Python, an environment is required. This assumes you have python and pip available on your machine. If you do not, please install them. If running multiple times, you may want to change `eval` to `FALSE` in the code chunk below to prevent the environment from being created again.
```{zsh, engine.opts='-l', eval=FALSE}
# create virtual environment 
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

> [!IMPORTANT]  The following assumes:
> -  you are using a `zsh` shell. If you are using a different shell, please adjust the commands in the code chunks accordingly.
> - you are in the root directory of the repository. If you are not, please adjust the paths in the code chunks accordingly.

Due to the extensive number of simulation studies, real data applications and illustrative figures, we have only included the code to reproduce the results for those in the main body of the text. Further instructions to reproduce the results for those in the supplementary material are detailed at relevant points in the document. All figures included in the poster for the **Bioinference 2025 conference** are from the main body of the paper and as such are reproduced here.

Any figures from the paper that are not produced by code (i.e. illustrations) are not included in this document. 

Code to reproduce the results is structured as follows:
- Simulation studies
  - Figure 5
- Real data applications
  - Table 2
  - Figure 6
  - Figure 7
- Additional figures
  - Figure 3

Lastly, due to long run times several modifications have been made:
1. The simulation studies were run with 100 repetitions, this has been changed to 3 repetitions. To run with the full number of repetitions, simply change the `n_reps` parameter in the relevant code chunk.
2. The code chunks to reproduce the results on the real data (which take substantially longer to run (at least a day each) than the simulations) have been set to `eval=FALSE` and `include=FALSE` to prevent the code from running. To run the code, simply remove these two arguments.
 
# Simulation studies

## Figure 5
### (A-B) Increasing number of biclusters
To run the simulation study for increasing the number of biclusters (on the base scenario of three views), with 5 repetitions, the following code chunk can be used:
```{zsh, engine.opts='-l'}
export sim="bicl"
export sim_folder_name="bicl_3v"
export seq=(3 4 5 6)
export n_reps=3
run_sim.sh $sim $sim_folder_name $n_reps $seq
```

> [!IMPORTANT]  
> The full results produced can now be found in the `SimStudy/Results/bicl_3v` folder, individually under various file names (`F_score_plot.pdf`, `BiS_plot.pdf`, etc.) or in one pdf (`results.pdf`). 

Some of the results are shown below:
```{r}
knitr::include_graphics("SimStudy/Results/bicl_3v/F_score_plot.pdf")
knitr::include_graphics("SimStudy/Results/bicl_3v/BiS_plot.pdf")
```


The remaining experiments can be reproduced by setting the `sim`, `sim_folder_name` and `seq` variables to the relevant names in the code chunk above. 
The variable names for the other experiments in Figure 6 are:
  - (C-D) Increasing number of views: `views`, `views_5b`, `2 3 4 5`
  - (E-F) Increasing number of individuals: `indiv`, `indiv_3v5b`, `50 200 300 500 1000`
  - (G-H) Increasing level of noise: `noise`, `noise_3v5b`, `1 2 3 4 5 6 7 8 9 10 20 30 40 50 60 70 80 90 100`

The variable names for remaining experiments are detailed in the readme file.For a specific simulation, the `seq` variable is found in the corresponding `SimStudy/Scripts/[sim_folder_name]_script_one.sh` file, in the for loop. 

> [!INFO] The experiments were initially run on clusters, the scripts to run the simulations on clusters can be found in the `SimStudy/Scripts` folder where each experiment has a `[sim_study]_script_one.sh` and  a`[sim_study]_script_two.sh` file.

# Real data

## Table 2: Table of results

## Figure 6
### (A) Relvance against increasing $\omega$
```{zsh, engine.opts='-l', eval=FALSE}
Rscript --vanilla RealData/3sources/3s_stab.r  "resnmtf" 1100
# combine results
cd RealData
Rscript --vanilla combine_stab_metrics.r  "3sources" 3 
cd ..
```
This produces the following figure:
```{r}
knitr::include_graphics("RealData/3sources/stab_plot_bis.pdf")
```

### (B) Correlation of F score and the bisilhouette score
```{zsh, engine.opts='-l', eval=FALSE}
Rscript --vanilla RealData/single_cell/phi_investigate.r  "euclidean" "3sources" 
cd RealData
Rscript --vanilla combine_phi_metrics.r  "single_cell" 2
cd ..
```
This produces the following figure:
```{r}
knitr::include_graphics("RealData/single_cell/single_cell_f_score_bis_psi.pdf")
```

## Figure 7 - bisilhouette plots
### (A) Shuffled synthetic data
The following code chunk creates and save the bisilhouette plot for the shuffled synthetic data. This is saved to `Exploration/visual_data/shuffled_bisil_plot.pdf`.
```{r}
source("Exploration/visualisation_ex.r")
knitr::include_graphics("Exploration/visual_data/shuffled_bisil_plot.pdf")
```

### (B) Real data - A549 dataset
The code chunk for Figure 6B also creates and save the bisilhouette plot for the A549 dataset. This is saved to `RealData/single_cell/sc_bisil_plot.pdf`.
```{r}
knitr::include_graphics("RealData/single_cell/sc_bisil_plot.pdf")
```

# Paper figures
## Figure 3 -  spurious biclusters illustrations
The following code chunk creates and save the two subfigures in Figure 3. These are saved to `Exploration/f_data_dists.pdf' and 'Exploration/shuffled_data_dists.pdf'.
```{r}
source("Exploration/JSD_diff_dists.r")
```

